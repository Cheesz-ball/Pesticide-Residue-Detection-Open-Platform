<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>农药残留检测开放平台</title>
    <link href="./css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>
</head>
<body>
<div>
    <header class="top-navbar">
        <div class="logo">
            <img alt="农药检测" src="./src/image/logo.png">
            <h1>农药残留开放检测平台</h1>
        </div>
        <nav class="top-navbar-links">
            <a class="top-navbar-links-item" href="./dashboard">检测仪表盘</a>
            <a class="top-navbar-links-item" href="analysis.html">分析</a>
            <a class="top-navbar-links-item" href="./new">数据库</a>
            <a class="top-navbar-links-item" href="./history">分析历史</a>
            <a class="top-navbar-links-item" href="./report">帮助</a>
            <div class="top-navbar-profile">
                <button class="top-navbar-profile-button">
                    <img alt="list" class="top-navbar-profile-image" src="./src/image/QQ.jpg">
                    <span>Name</span>
                </button>
                <div class="top-navbar-profile-dropdown">
                    <a class="top-navbar-profile-dropdown-item" href="./profile/test1">
                        <img alt="profile" class="top-navbar-profile-dropdown-image" src="./src/image/user.png">test
                    </a>
                    <a class="top-navbar-profile-dropdown-item" href="./profile/test1">
                        <img alt="profile" class="top-navbar-profile-dropdown-image" src="./src/image/user.png">test
                    </a>
                    <a class="top-navbar-profile-dropdown-item" href="./profile/test1">
                        <img alt="profile" class="top-navbar-profile-dropdown-image" src="./src/image/user.png">test
                    </a>
                </div>
            </div>
        </nav>
    </header>
    <main class="main-content">


        <script>
            fetch('http://localhost:8000/api/get_current_testing_progress')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('current_testing_progress').innerHTML = `
                    <h2>${data.value}</h2>
                    `;
                })
                .catch(error => {
                    document.getElementById('current_testing_progress').innerHTML = error;
                });
        </script>

<!--        农药超标率统计-->
        <div class="status-card">
            <a class="status-card-title">农药超标率统计</a>
            <div id="test" style="width: 600px;height:400px;"></div>
        </div>
        <script>
            const chart = echarts.init(document.getElementById('test'));

            fetch('http://127.0.0.1:8000/api/chart-data/')
                .then(response => response.json())
                .then(data => {
                    // 动态生成图表配置
                    const option = {
                        title: {text: data.title},
                        tooltip: {},
                        legend: {
                            data: data.series.map(item => item.name)
                        },
                        xAxis: {
                            data: data.categories
                        },
                        yAxis: {},
                        series: data.series
                    };
                    chart.setOption(option);
                })
                .catch(error => {
                    console.error('加载数据失败:', error);
                    chart.setOption({
                        title: {text: '数据加载失败'},
                        xAxis: {},
                        yAxis: {},
                        series: []
                    });
                });

            // 窗口大小变化时重绘图表
            window.addEventListener('resize', function () {
                chart.resize();
            });
        </script>

<!--        当前检测进度-->
        <div class="status-card">
            <a class="status-card-title">当前检测进度</a>
            <a class="status-card-title" id="current_testing_progress">等待数据...</a>
        </div>
        <div class="status-card">
            <a class="status-card-title">最近检测时间</a>
            <a class="status-card-title" id="recent_detection_time">等待数据...</a>
        </div>
        <script>
            fetch('http://localhost:8000/api/get_recent_detection_time')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('recent_detection_time').innerHTML = `
                    <h2>${data.message}</h2>
                    `;
                })
                .catch(error => {
                    document.getElementById('recent_detection_time').innerHTML = error;
                });
        </script>


        <div class="status-card">
            <a class="status-card-title">总检测数量</a>
            <a class="status-card-title" id="all_analysis_sum">等待数据...</a>
        </div>

        <script>
            fetch('http://127.0.0.1:8000/api/get_all_analysis_sum/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('all_analysis_sum').innerHTML = `
                    <h2>${data.value}</h2>
                `;
                })
                .catch(error => {
                    document.getElementById('all_analysis_sum').textContent = '获取数据失败';
                });
        </script>
        <div class="status-card">
            <a class="status-card-title">本周/月异常样本趋势</a>
            <div id="abnormal_trend" style="min-width: 300px; height: 400px; flex: 1"></div>
        </div>
        <script>
            const abnormal_trend = echarts.init(document.getElementById('abnormal_trend'));
            abnormal_trend.setOption({
                title: {
                    text: ''
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {},
                toolbox: {
                    show: true,
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        dataView: { readOnly: false },
                        magicType: { type: ['line', 'bar'] },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value} °C'
                    }
                },
                series: [
                    {
                        name: 'Highest',
                        type: 'line',
                        data: [10, 11, 13, 11, 12, 12, 9],
                        markPoint: {
                            data: [
                                { type: 'max', name: 'Max' },
                                { type: 'min', name: 'Min' }
                            ]
                        },
                        markLine: {
                            data: [{ type: 'average', name: 'Avg' }]
                        }
                    },
                    {
                        name: 'Lowest',
                        type: 'line',
                        data: [1, -2, 2, 5, 3, 2, 0],
                        markPoint: {
                            data: [{ name: '周最低', value: -2, xAxis: 1, yAxis: -1.5 }]
                        },
                        markLine: {
                            data: [
                                { type: 'average', name: 'Avg' },
                                [
                                    {
                                        symbol: 'none',
                                        x: '90%',
                                        yAxis: 'max'
                                    },
                                    {
                                        symbol: 'circle',
                                        label: {
                                            position: 'start',
                                            formatter: 'Max'
                                        },
                                        type: 'max',
                                        name: '最高点'
                                    }
                                ]
                            ]
                        }
                    }
                ]
            });
        </script>
        <div class="status-card">
            <a class="status-card-title">CPU/内存使用率</a>
            <div class="chart-container" style="display: flex; justify-content: space-between"> <!-- 父容器设为 Flex -->
                <div id="cpu_usage" style="width: 300px; height: 400px;"></div>
                <div id="mem_usage" style="width: 300px; height: 400px;"></div>
            </div>
        </div>
        <script>
            const cpu_usage = echarts.init(document.getElementById('cpu_usage'));
            const mem_usage = echarts.init(document.getElementById('mem_usage'));

            fetch('http://127.0.0.1:8000/api/get_cpu_mem_usage')
                .then(response => response.json())
                .then(data => {
                    // 动态生成图表配置
                    const option1 = {
                        tooltip: {
                            trigger: 'item'
                        },
                        legend: {
                            top: '5%',
                            left: 'center'
                        },
                        series: [
                            {
                                name: data.series[0].name,
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                padAngle: 5,
                                itemStyle: {
                                    borderRadius: 10
                                },
                                label: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    label: {
                                        show: true,
                                        fontSize: 40,
                                        fontWeight: 'bold'
                                    }
                                },
                                labelLine: {
                                    show: false
                                },
                                data: data.series[0].data,
                            }
                        ]
                    };
                    const option2 = {
                        tooltip: {
                            trigger: 'item'
                        },
                        legend: {
                            top: '5%',
                            left: 'center'
                        },
                        series: [
                            {
                                name: data.series[1].name,
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                padAngle: 5,
                                itemStyle: {
                                    borderRadius: 10
                                },
                                label: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    label: {
                                        show: true,
                                        fontSize: 40,
                                        fontWeight: 'bold'
                                    }
                                },
                                labelLine: {
                                    show: false
                                },
                                data: data.series[1].data,
                            }
                        ]
                    };
                    cpu_usage.setOption(option1);
                    mem_usage.setOption(option2);
                })
                .catch(error => {
                    console.error('加载数据失败:', error);
                    cpu_usage.setOption({
                        title: {text: '数据加载失败'},
                        xAxis: {},
                        yAxis: {},
                        series: []
                    });
                });

            // 窗口大小变化时重绘图表
            window.addEventListener('resize', function () {
                chart.resize();
            });
        </script>

        <div class="status-card">
            <a class="status-card-title">近期活动记录</a>
        </div>
    </main>
</div>
</body>
</html>